<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio List View V10 - Mobile Optimized</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Model Viewer -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.5.0/model-viewer.min.js"></script>
    
    <style>
        /* --- FONTS --- */
        @font-face {
            font-family: 'Telegrama Raw';
            src: url('https://raw.githubusercontent.com/decentralize-dfw/font/main/telegrama_raw.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'Telegrama Render';
            src: url('https://raw.githubusercontent.com/decentralize-dfw/font/main/telegrama_render_osn.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'GAU Private';
            src: url('https://raw.githubusercontent.com/decentralize-dfw/font/main/GAU_private_R.TTF') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        /* --- GLOBAL SETTINGS --- */
        :root {
            --ui-color: #FF006A; 
            --bg-color: black;
            --modal-bg: #ffb8d5;
            
            /* Font Mapping */
            --font-headers: 'Telegrama Raw', sans-serif;
            --font-body: 'Telegrama Render', sans-serif;
            --font-display: 'GAU Private', cursive;
        }

        html, body {
            font-family: var(--font-body);
            background-color: var(--bg-color);
            color: var(--ui-color);
            scrollbar-width: none; 
            -ms-overflow-style: none; 
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            width: 100%;
        }

        ::placeholder {
            color: var(--ui-color);
            opacity: 0.5;
            font-family: var(--font-headers);
        }
        
        *::-webkit-scrollbar { display: none; width: 0; height: 0; background: transparent; }

        /* --- UI ELEMENTS --- */
        #search-input {
            font-family: var(--font-headers);
            border-color: rgba(255, 0, 106, 0.5);
        }
        #search-input:focus {
            border-color: var(--ui-color);
        }

        /* Filter Container */
        .filter-container-style {
            background-color: rgba(0, 0, 0, 0.5); 
            padding: 4px 8px; /* Reduced padding for mobile compactness */
            border-radius: 30px; 
            border: 1px solid rgba(255, 0, 106, 0.3);
            backdrop-filter: blur(5px);
            display: inline-flex;
            flex-wrap: wrap;
            gap: 0.25rem; /* Tighter gap */
        }

        .filter-button {
            background: transparent; 
            border: 1px solid transparent; 
            color: var(--ui-color);
            padding: 2px 8px;
            text-transform: uppercase;
            font-family: var(--font-headers);
            font-size: 0.7rem; /* Slightly smaller */
            font-weight: 500;
            letter-spacing: 0.5px;
            cursor: pointer; 
            transition: all 0.2s ease; 
            border-radius: 0.25rem; 
            opacity: 0.7;
        }
        .filter-button:hover { 
            opacity: 1; 
            border-color: var(--ui-color); 
            text-shadow: 0 0 8px var(--ui-color); 
        }
        .filter-button.active { 
            background-color: rgba(255, 0, 106, 0.1); 
            color: var(--ui-color); 
            border-color: var(--ui-color); 
            opacity: 1; 
        }

        /* --- ACCORDION --- */
        #accordion-header {
            font-family: var(--font-headers);
            border-color: var(--ui-color);
            background-color: var(--bg-color);
            opacity: 0.9;
        }

        .accordion-toggle {
            font-family: var(--font-display);
            /* Font size handled via Tailwind classes now for responsiveness */
            line-height: 1;
            border-color: rgba(255, 0, 106, 0.3);
        }
        
        .subtype-toggle {
            font-family: var(--font-headers);
            font-size: 1rem;
            border-color: rgba(255, 0, 106, 0.2);
        }

        .project-row {
            font-family: var(--font-body);
            border-color: rgba(255, 0, 106, 0.1);
            transition: background-color 0.2s, opacity 0.2s;
        }
        .project-row:hover, .project-row:active {
            background-color: rgba(255, 0, 106, 0.1);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
        }
        .accordion-content.overflow-visible {
            overflow: visible !important;
            max-height: none !important;
        }
        .subtype-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        /* --- DIMMING LOGIC --- */
        .dimmable { opacity: 1; transition: opacity 0.2s; }
        #accordion-container.is-hovering .dimmable { opacity: 0.25 !important; }
        #accordion-container.is-hovering .dimmable.highlighted { opacity: 1 !important; }
        #accordion-container.is-hovering .subtype-toggle.active { opacity: 1 !important; }

        /* --- PREVIEW --- */
        #thumbnail-preview {
            position: fixed;
            z-index: 1000;
            pointer-events: none; 
            opacity: 0;
            transition: opacity 0.2s ease-out;
            border: 1px solid var(--ui-color);
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.8);
            background: black;
            max-width: 250px;
            max-height: 250px;
            object-fit: contain;
        }
        #thumbnail-preview.visible { opacity: 1; }

        /* --- MODAL --- */
        #modal-container {
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease-out, visibility 0.3s ease-out;
        }
        #modal-container.open { opacity: 1; visibility: visible; }
        
        #modal-backdrop {
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease-out, visibility 0.3s ease-out;
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
        }
        #modal-backdrop.open { opacity: 1; visibility: visible; }

        #modal-content {
            background-color: var(--modal-bg);
            color: var(--ui-color);
            border: 1px solid var(--ui-color);
            box-shadow: 0 20px 50px rgba(255, 0, 106, 0.2);
        }

        /* Modal Scrollbars */
        .media-scroller::-webkit-scrollbar { display: block; height: 6px; }
        .media-scroller::-webkit-scrollbar-track { background: transparent; }
        .media-scroller::-webkit-scrollbar-thumb { background: var(--ui-color); border-radius: 3px; opacity: 0.5; border: none; }
        
        #modal-left-col::-webkit-scrollbar, #modal-right-col::-webkit-scrollbar { display: block; width: 4px; }
        #modal-left-col::-webkit-scrollbar-thumb, #modal-right-col::-webkit-scrollbar-thumb { background: var(--ui-color); border-radius: 2px; border: none; }

        /* Modal Typography - UPDATED FOR SMALLER MOBILE FONTS */
        .modal-label { 
            font-family: var(--font-headers); 
            font-weight: 500; 
            font-size: 0.4rem; /* Ultra small for mobile (approx 6-7px) */
            line-height: 1.1;
        } 
        .modal-value { 
            font-family: var(--font-body); 
            font-weight: 400; 
            font-size: 0.45rem; /* Ultra small for mobile */
            line-height: 1.1;
        }
        .modal-desc { 
            font-family: var(--font-body); 
            font-weight: 400; 
            font-size: 0.65rem; /* Small description text on mobile */
            line-height: 1.25; 
        }

        /* Desktop Overrides - Restore readable sizes */
        @media (min-width: 768px) {
            .modal-label { font-size: 0.8rem; line-height: 1.5; }
            .modal-value { font-size: 0.8rem; line-height: 1.5; }
            .modal-desc { font-size: 1rem; line-height: 1.5; }
        }

        .ui-text { color: var(--ui-color); }
        .ui-border { border-color: var(--ui-color); }
    </style>
</head>
<body>

    <!-- Main Container -->
    <div class="container mx-auto p-4 md:p-8 w-full max-w-full overflow-hidden"> 
        
        <!-- Header & Filters -->
        <header class="mb-4"> 
            <!-- Smaller font on mobile (text-lg) vs desktop (text-2xl approx) -->
            <input type="text" id="search-input" class="w-full bg-transparent border-b-2 rounded-none py-1 md:py-2 px-2 mb-2 md:mb-4 focus:outline-none text-lg md:text-2xl" placeholder="SEARCH">
            
            <div class="flex flex-wrap gap-2 items-center mt-2">
                <!-- Applied 'filter-container-style' to mimic the 3D menu bar -->
                <div id="filter-buttons-container" class="filter-container-style">
                    <!-- Buttons will be injected here -->
                </div>
            </div>
        </header>

        <!-- Column Headers -->
        <!-- Mobile: Hidden logic handled manually via JS or reduced cols -->
        <div id="accordion-header" class="flex sticky top-0 z-10 py-2 border-b-2 mt-4 text-sm md:text-lg font-normal uppercase bg-black">
            <!-- Mobile: Name is 70%, 1st Cat is 30%. Desktop: Name 40%, others 15% -->
            <div class="w-[70%] md:w-[40%] px-2 truncate">Work Title</div> 
            <div id="dynamic-header-1" class="w-[30%] md:w-[15%] px-2 capitalize truncate text-right md:text-left"></div>
            <div id="dynamic-header-2" class="hidden md:block w-[15%] px-2 capitalize truncate"></div>
            <div id="dynamic-header-3" class="hidden md:block w-[15%] px-2 capitalize truncate"></div>
            <div id="dynamic-header-4" class="hidden md:block w-[15%] px-2 capitalize truncate"></div>
        </div>

        <!-- Content Container -->
        <div id="accordion-container" class="w-full">
            <!-- Content injected via JS -->
        </div>

    </div>

    <!-- Thumbnail Preview -->
    <img id="thumbnail-preview" src="" alt="Preview">

    <!-- Modal -->
    <div id="modal-container" tabindex="-1" class="fixed inset-0 z-40 flex items-center justify-center p-2 md:p-12 outline-none">
        <div id="modal-backdrop" class="fixed inset-0 z-40"></div>
        
        <div id="modal-content" class="relative z-50 w-full h-full rounded-lg shadow-xl flex flex-col overflow-hidden">
            <button id="modal-close-btn" class="absolute top-4 right-4 z-50 text-sm font-medium px-3 py-1 rounded-md border ui-border ui-text bg-black/60 hover:bg-black/80 transition-colors text-white" style="font-family: var(--font-headers);">
                CLOSE
            </button>
            
            <div id="modal-media-scroller" class="media-scroller w-full h-[50%] md:h-[60%] flex-shrink-0 overflow-x-auto overflow-y-hidden whitespace-nowrap border-b ui-border flex items-center p-4 gap-4 bg-black/5"></div>
            
            <!-- CHANGED: Used flex-col on mobile to let left-col hug content height, grid on desktop -->
            <div class="w-full h-[50%] md:h-[40%] flex flex-col md:grid md:grid-cols-2 gap-px ui-border">
                
                <!-- 
                   CHANGED LEFT COL: 
                   - flex-shrink-0: prevents it from growing to fill half height on mobile, hugs content instead.
                   - border-b: now acts as the separator line immediately after content on mobile.
                   - md:border-b-0 md:border-r: Switches to vertical border on desktop.
                -->
                <div id="modal-left-col" class="p-4 md:p-[3%] flex-shrink-0 border-b md:border-b-0 md:border-r ui-border flex flex-col" style="background-color: var(--modal-bg);"></div>
                
                <!-- 
                   CHANGED RIGHT COL:
                   - flex-grow: takes up all remaining space in the container on mobile.
                   - overflow-y-auto: scrolls if text is long.
                -->
                <div id="modal-right-col" class="p-4 md:p-[5%] flex-grow overflow-y-auto" style="background-color: var(--modal-bg);"></div>
            </div>
        </div>
    </div>


    <script>
        // --- 1. DATA (REDUCED SET: 10 Items) ---
        // SWAPPED 'contents' and 'medium' order here
        const categoryPriorityList = ['type', 'year', 'collection', 'contents', 'expression', 'reality', 'medium'];

        const projects = [
            {
                id: "fig-1",
                name: "penguin is not a friend, only a sinner",
                description: "acrylic on 120x120 canvas, 2023",
                link: null,
                media: [{ "type": "image", "src": "https://raw.githubusercontent.com/decentralize-dfw/decentralize-archives/main/a161.png" }],
                categories: { year: 2023, type: "painting", subtype: "figurative", collection: "irl", medium: "canvas", expression: "decentralize*", reality: "irl", contents: "drawing" }
            },
            {
                id: "fig-2",
                name: "despite transgression",
                description: "acrylic on 100x160 gray carton, 2019",
                link: null,
                media: [{ "type": "image", "src": "https://raw.githubusercontent.com/decentralize-dfw/decentralize-archives/main/a122.png" }],
                categories: { year: 2019, type: "painting", subtype: "figurative", collection: "irl", medium: "canvas", expression: "decentralize*", reality: "irl", contents: "drawing" }
            },
            {
                id: "fig-3",
                name: "cellular spleens",
                description: "acrylic on 100x120 canvas, 2020",
                link: null,
                media: [{ "type": "image", "src": "https://raw.githubusercontent.com/decentralize-dfw/decentralize-archives/main/a130.png" }],
                categories: { year: 2020, type: "painting", subtype: "figurative", collection: "irl", medium: "canvas", expression: "decentralize*", reality: "irl", contents: "drawing" }
            },
            {
                id: "ske-1",
                name: "xyyz008-s prototype",
                description: "colored pencil on A4 print, 2020",
                link: null,
                media: [{ "type": "image", "src": "https://raw.githubusercontent.com/decentralize-dfw/decentralize-archives/main/b1.png" }],
                categories: { year: 2020, type: "painting", subtype: "sketch", collection: "irl", medium: "paper", expression: "decentralize*", reality: "irl", contents: "drawing" }
            },
            {
                id: "ske-2",
                name: "protecting the big cat with cross",
                description: "pencil on A3 thick paper, 2019",
                link: null,
                media: [{ "type": "image", "src": "https://raw.githubusercontent.com/decentralize-dfw/decentralize-archives/main/b10.png" }],
                categories: { year: 2019, type: "painting", subtype: "sketch", collection: "irl", medium: "paper", expression: "decentralize*", reality: "irl", contents: "drawing" }
            },
            {
                id: "fwssexp-1",
                name: "3rd WebCam Opening Ceremony",
                description: "Fwsssexp depicts a sterile, AI-dominated future where organic expression is punished.",
                link: null,
                media: [{ type: "video", src: "https://video.wixstatic.com/video/54a996_dd5df10a12914518a981167064f1b903/1080p/mp4/file.mp4" },
                { type: "image", src: "https://raw.githubusercontent.com/decentralize-dfw/decentralize-archives-thumbnail/main/fwssexp-1.png" }],
                categories: { year: 2020, type: "digital art", subtype: "Future Wabi-Sabi Spacescape Exp.", collection: "Future Wabi-sabi Spacescape Experiments", medium: "computer", expression: "early religious robotics", reality: "meta", contents: "video" }
            },
            {
                id: "fwssexp-4",
                name: "Aigorithmin Dominus Republic Seal",
                description: "Blockchain Based Official Seal",
                link: null,
                media: [{ type: "image", src: "https://raw.githubusercontent.com/decentralize-dfw/decentralize-archives/main/Aigorithmin%20Dominus%20Republic%20-%20Blockchain%20Based%20Official%20Seal.jpg" }],
                categories: { year: 2020, type: "digital art", subtype: "Future Wabi-Sabi Spacescape Exp.", collection: "Future Wabi-sabi Spacescape Experiments", medium: "computer", expression: "early religious robotics", reality: "meta", contents: "digital image" }
            },
            {
                id: "people-1",
                name: "0-70",
                description: "milano, 2018",
                link: null,
                media: [{ "type": "image", "src": "https://raw.githubusercontent.com/decentralize-dfw/decentralize-archives/main/0-70.jpg" }],
                categories: { year: 2018, type: "photography", subtype: "people", collection: "Killing the Moment", medium: "photo", expression: "decentralize*early", reality: "irl", contents: "photography" }
            },
            {
                id: "people-2",
                name: "0-70-1",
                description: "milano, 2018",
                link: null,
                media: [{ "type": "image", "src": "https://raw.githubusercontent.com/decentralize-dfw/decentralize-archives/main/0-70-1.jpg" }],
                categories: { year: 2018, type: "photography", subtype: "people", collection: "Killing the Moment", medium: "photo", expression: "decentralize*early", reality: "irl", contents: "photography" }
            },
            { 
                id: "demo-1", 
                name: "MEDIA TEST DEMO", 
                description: "This project demonstrates 3D Model (GLB), Video (MP4) and HTML Embed (YouTube) support.", 
                link: null, 
                media: [
                    { "type": "model", "src": "https://raw.githubusercontent.com/decentralize-dfw/c2w2-glb/main/seize-centerobject-opt-v1.glb" },
                    { "type": "html", "src": "https://raw.githubusercontent.com/decentralize-dfw/finder/refs/heads/main/decentralize.html" }, 
                    { "type": "video", "src": "https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4" },
                ], 
                categories: { year: 2024, type: "digital art", subtype: "Future Wabi-Sabi Spacescape Exp.", collection: "Future Wabi-sabi Spacescape Experiments", medium: "computer", expression: "early religious robotics", reality: "meta", contents: "digital image" } 
            }
        ];

        // --- 2. GLOBAL VARIABLES ---
        let currentGroupKey = 'type'; 
        let currentSearchQuery = '';
        const accordionContainer = document.getElementById('accordion-container');
        const filterButtonsContainer = document.getElementById('filter-buttons-container');
        const searchInput = document.getElementById('search-input');
        
        const modalContainer = document.getElementById('modal-container');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalCloseBtn = document.getElementById('modal-close-btn'); 
        const modalLeftCol = document.getElementById('modal-left-col');
        const modalRightCol = document.getElementById('modal-right-col');
        const modalMediaScroller = document.getElementById('modal-media-scroller');
        const thumbnailPreview = document.getElementById('thumbnail-preview');

        // --- 3. FUNCTIONS ---

        function resetGroupState(contentDiv) {
            contentDiv.querySelectorAll('.subtype-toggle.active').forEach(t => t.classList.remove('active'));
            contentDiv.querySelectorAll('.subtype-content.open').forEach(c => {
                c.classList.remove('open');
                c.style.maxHeight = null;
            });
            contentDiv.classList.remove('has-open-subtype');
        }

        function renderAccordion() {
            accordionContainer.innerHTML = ''; 
            accordionContainer.classList.remove('has-active-group');
            
            const filteredProjects = projects.filter(project => {
                if (!currentSearchQuery) return true;
                const query = currentSearchQuery.toLowerCase();
                
                if (project.name.toLowerCase().includes(query)) return true;

                const inCategories = Object.values(project.categories).some(val => 
                    String(val || '').toLowerCase().includes(query)
                );
                return inCategories;
            });

            const mainGroups = filteredProjects.reduce((acc, project) => {
                const key = project.categories[currentGroupKey] || 'Other';
                if (!acc[key]) acc[key] = [];
                acc[key].push(project);
                return acc;
            }, {});

            const dynamicHeaders = getDynamicHeaders(currentGroupKey);
            updateAccordionHeaders(dynamicHeaders);

            const sortedMainGroupNames = Object.keys(mainGroups).sort();
            const enableSubtypeGrouping = (currentGroupKey === 'type');
            
            sortedMainGroupNames.forEach(mainGroupName => {
                const groupProjects = mainGroups[mainGroupName];

                const mainGroupToggle = document.createElement('div');
                // RESPONSIVE FONT SIZE: text-xl (mobile) vs text-4xl (desktop/default logic, tweaked)
                // Desktop was around 2.5rem (approx text-4xl), Mobile requested 50% smaller -> text-xl
                mainGroupToggle.className = 'accordion-toggle dimmable flex py-2 px-2 border-b-2 ui-border cursor-pointer transition-opacity duration-300 font-bold ui-text text-xl md:text-4xl';
                mainGroupToggle.innerHTML = `<span class="uppercase">${mainGroupName}</span>`;
                
                const mainContentDiv = document.createElement('div');
                mainContentDiv.className = 'accordion-content';

                if (enableSubtypeGrouping) {
                    const projectsWithoutSubtype = groupProjects.filter(p => !p.categories.subtype);
                    const projectsWithSubtype = groupProjects.filter(p => p.categories.subtype);

                    projectsWithoutSubtype.forEach(project => {
                        const row = createProjectRow(project, dynamicHeaders);
                        addHoverLogic(row, [row, mainGroupToggle]);
                        mainContentDiv.appendChild(row);
                    });
                    
                    const subGroups = projectsWithSubtype.reduce((acc, project) => {
                        const subKey = project.categories.subtype; 
                        if (!acc[subKey]) acc[subKey] = [];
                        acc[subKey].push(project);
                        return acc;
                    }, {});

                    const sortedSubGroupNames = Object.keys(subGroups).sort();

                    sortedSubGroupNames.forEach(subGroupName => {
                        const subGroupProjects = subGroups[subGroupName];

                        const subtypeToggle = document.createElement('div');
                        subtypeToggle.className = 'subtype-toggle dimmable flex items-center py-2 px-2 border-b ui-border text-lg font-medium ui-text ml-0 md:ml-4';
                        subtypeToggle.innerHTML = `<div class="w-full capitalize pl-2 flex items-center text-sm tracking-widest">${subGroupName}</div>`;

                        const subtypeContentDiv = document.createElement('div');
                        subtypeContentDiv.className = 'subtype-content ml-0 md:ml-8'; 

                        subGroupProjects.forEach(project => {
                            const projectRow = createProjectRow(project, dynamicHeaders);
                            addHoverLogic(projectRow, [projectRow, subtypeToggle, mainGroupToggle]);
                            subtypeContentDiv.appendChild(projectRow);
                        });
                        
                        addHoverLogic(subtypeToggle, [subtypeToggle, mainGroupToggle]);

                        subtypeToggle.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const isOpen = subtypeContentDiv.classList.contains('open');
                            
                            if (isOpen) {
                                closeSubtype(subtypeToggle, subtypeContentDiv);
                                if (!mainContentDiv.querySelector('.subtype-content.open')) {
                                    mainContentDiv.classList.remove('has-open-subtype');
                                }
                            } else {
                                mainContentDiv.querySelectorAll('.subtype-content.open').forEach(openContent => {
                                    let siblingToggle = openContent.previousElementSibling;
                                    while(siblingToggle && !siblingToggle.classList.contains('subtype-toggle')) {
                                        siblingToggle = siblingToggle.previousElementSibling;
                                    }
                                    if (siblingToggle) closeSubtype(siblingToggle, openContent);
                                });

                                subtypeContentDiv.style.maxHeight = subtypeContentDiv.scrollHeight + "px";
                                subtypeContentDiv.classList.add('open');
                                subtypeToggle.classList.add('active');
                                mainContentDiv.classList.add('has-open-subtype');
                            }
                        });

                        mainContentDiv.appendChild(subtypeToggle);
                        mainContentDiv.appendChild(subtypeContentDiv);
                    }); 

                } else {
                    groupProjects.forEach(project => {
                        const row = createProjectRow(project, dynamicHeaders);
                        addHoverLogic(row, [row, mainGroupToggle]);
                        mainContentDiv.appendChild(row);
                    });
                }

                addHoverLogic(mainGroupToggle, [mainGroupToggle]);

                mainGroupToggle.addEventListener('click', () => {
                    const wasActive = mainGroupToggle.classList.contains('active');
                    
                    const currentActive = document.querySelector('.accordion-toggle.active');
                    if (currentActive && currentActive !== mainGroupToggle) {
                        currentActive.classList.remove('active');
                        const content = currentActive.nextElementSibling;
                        resetGroupState(content);
                        content.style.maxHeight = null;
                        content.classList.remove('overflow-visible'); 
                    }

                    if (wasActive) {
                        mainGroupToggle.classList.remove('active');
                        resetGroupState(mainContentDiv);
                        mainContentDiv.style.maxHeight = null;
                        mainContentDiv.classList.remove('overflow-visible');
                    } else {
                        mainGroupToggle.classList.add('active');
                        mainContentDiv.style.maxHeight = mainContentDiv.scrollHeight + "px";
                        setTimeout(() => {
                            if(mainGroupToggle.classList.contains('active')) {
                                mainContentDiv.classList.add('overflow-visible');
                            }
                        }, 400); 
                    }

                    setTimeout(() => {
                        const anyActive = accordionContainer.querySelector('.accordion-toggle.active');
                        if (anyActive) {
                            accordionContainer.classList.add('has-active-group');
                        } else {
                            accordionContainer.classList.remove('has-active-group');
                        }
                    }, 50); 
                });
                
                if (currentSearchQuery) {
                    mainGroupToggle.click(); 
                    if(enableSubtypeGrouping) {
                        setTimeout(() => {
                            mainContentDiv.querySelectorAll('.subtype-toggle').forEach(t => t.click());
                        }, 100);
                    }
                }

                accordionContainer.appendChild(mainGroupToggle);
                accordionContainer.appendChild(mainContentDiv);
            });
        }
        
        function createProjectRow(project, dynamicHeaders) {
            const projectRow = document.createElement('div');
            projectRow.className = 'project-row dimmable flex cursor-pointer py-2 md:py-1 px-2 border-b ui-border text-sm ui-text items-center relative';
            
            let headersHtml = '';
            dynamicHeaders.forEach((key, index) => {
                const value = project.categories[key] || '-';
                
                // RESPONSIVE COLUMNS
                // Index 0: Visible always, width adjusts (30% mobile, 15% desktop)
                // Index > 0: Hidden on mobile, visible on desktop
                let classNames = "py-1 px-2 capitalize overflow-hidden text-ellipsis whitespace-nowrap opacity-80 ";
                
                if (index === 0) {
                    classNames += "w-[30%] md:w-[15%] text-right md:text-left";
                } else {
                    classNames += "hidden md:block w-[15%]";
                }

                headersHtml += `<div class="${classNames}">${value}</div>`;
            });
            
            // RESPONSIVE NAME COLUMN
            // Mobile: 70%, Desktop: 40%
            projectRow.innerHTML = `
                <div class="w-[70%] md:w-[40%] font-normal pl-2 md:pl-4 flex items-center truncate pr-2">${project.name}</div>
                ${headersHtml}
            `;
            
            // Interaction: Click
            projectRow.addEventListener('click', (e) => {
                e.stopPropagation(); 
                // Small delay to ensure touch scroll doesn't trigger open accidentally, but click does
                openModal(project.id);
            });

            // Interaction: Mouse (Desktop)
            projectRow.addEventListener('mouseenter', (e) => showThumbnail(e, project.id));
            projectRow.addEventListener('mouseleave', hideThumbnail);

            // Interaction: Touch (Mobile - Finger Over)
            projectRow.addEventListener('touchstart', (e) => {
                // Prevent default can block scrolling, use carefully. 
                // We want to show thumbnail, but let click handle modal.
                // e.preventDefault(); // removed to allow click through
                const touch = e.touches[0];
                showThumbnail({ clientX: touch.clientX, clientY: touch.clientY, isTouch: true }, project.id);
            }, {passive: true});

            projectRow.addEventListener('touchend', hideThumbnail);
            
            return projectRow;
        }

        function closeSubtype(toggleEl, contentEl) {
            contentEl.style.maxHeight = null;
            contentEl.classList.remove('open');
            toggleEl.classList.remove('active');
        }

        function addHoverLogic(element, highlightList) {
            // Desktop Hover
            element.addEventListener('mouseenter', () => {
                accordionContainer.classList.add('is-hovering');
                highlightList.forEach(el => el.classList.add('highlighted'));
            });
            element.addEventListener('mouseleave', () => {
                accordionContainer.classList.remove('is-hovering');
                document.querySelectorAll('.highlighted').forEach(el => el.classList.remove('highlighted'));
            });

            // Mobile Touch Highlight logic (Simulate hover dimming)
            element.addEventListener('touchstart', () => {
                 accordionContainer.classList.add('is-hovering');
                 highlightList.forEach(el => el.classList.add('highlighted'));
            }, {passive: true});
             element.addEventListener('touchend', () => {
                 setTimeout(() => {
                    accordionContainer.classList.remove('is-hovering');
                    document.querySelectorAll('.highlighted').forEach(el => el.classList.remove('highlighted'));
                 }, 300);
            });
        }

        function updateAccordionHeaders(headers) {
            document.getElementById('accordion-header').classList.toggle('hidden', headers.length === 0);
            for (let i = 0; i < 4; i++) {
                const headerEl = document.getElementById(`dynamic-header-${i + 1}`);
                if (headerEl) {
                    headerEl.textContent = headers[i] || '';
                }
            }
        }
        
        function getDynamicHeaders(activeKey) {
            // 'subtype' is excluded, active key is excluded
            return categoryPriorityList
                .filter(key => key !== activeKey && key !== 'subtype') 
                .slice(0, 4); 
        }

        function renderFilterButtons() {
            filterButtonsContainer.innerHTML = '';
            // Exclude 'subtype' from buttons
            const filters = categoryPriorityList.filter(k => k !== 'subtype');
            
            filters.forEach(key => {
                const button = document.createElement('button');
                button.className = 'filter-button';
                button.textContent = key;
                if (key === currentGroupKey) {
                    button.classList.add('active');
                }
                button.addEventListener('click', () => {
                    currentGroupKey = key;
                    document.querySelectorAll('.filter-button.active').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    renderAccordion();
                });
                filterButtonsContainer.appendChild(button);
            });
        }
        
        // --- THUMBNAIL LOGIC ---
        function showThumbnail(event, projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;

            const imageMedia = project.media.find(m => m.type === 'image');
            
            let thumbUrl;

            if (imageMedia) {
                // TRICK: Extract filename and use the thumbnail repository
                const filename = imageMedia.src.split('/').pop().replace(/\.[^/.]+$/, "");
                thumbUrl = `https://raw.githubusercontent.com/decentralize-dfw/decentralize-archives-thumbnail/main/${filename}.png`;
            } else {
                const safeName = project.name.replace(/\s+/g, '+');
                thumbUrl = `https://placehold.co/400x400/000000/FFFFFF?text=${safeName}`;
            }

            if (thumbUrl) {
                thumbnailPreview.src = thumbUrl;
                thumbnailPreview.onerror = function() {
                    if (imageMedia) this.src = imageMedia.src; 
                };
                
                // Position logic: 
                // Mobile (touch): Fixed position bottom-right
                // Desktop (mouse): Follow cursor
                
                if (event.isTouch || window.innerWidth < 768) {
                    // Mobile Position: Fixed at bottom right, but not edge
                    thumbnailPreview.style.left = 'auto';
                    thumbnailPreview.style.top = 'auto';
                    thumbnailPreview.style.right = '20px';
                    thumbnailPreview.style.bottom = '80px'; 
                } else {
                    // Desktop Position: Cursor follow
                    let leftPos = event.clientX + 15;
                    let topPos = event.clientY + 15;
                    
                    // Simple bounds check
                    if (leftPos + 250 > window.innerWidth) {
                        leftPos = event.clientX - 265; // Flip to left
                    }
                    
                    thumbnailPreview.style.left = leftPos + 'px';
                    thumbnailPreview.style.top = topPos + 'px';
                    // Reset mobile overrides
                    thumbnailPreview.style.right = 'auto';
                    thumbnailPreview.style.bottom = 'auto';
                }

                thumbnailPreview.classList.add('visible');
            }
        }
        
        function hideThumbnail() {
            thumbnailPreview.classList.remove('visible');
        }

        // --- MODAL LOGIC ---
        function openModal(projectId) {
            hideThumbnail(); // Force hide thumbnail immediately
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            modalMediaScroller.innerHTML = '';
            
            project.media.forEach(media => {
                let mediaEl;
                if (media.type === 'image') {
                    mediaEl = document.createElement('img');
                    mediaEl.src = media.src;
                    mediaEl.className = "inline-block h-full object-contain mr-4"; 
                } else if (media.type === 'video') {
                    mediaEl = document.createElement('video');
                    mediaEl.src = media.src;
                    mediaEl.controls = true;
                    mediaEl.className = "inline-block h-full object-contain mr-4";
                } else if (media.type === 'model') {
                    mediaEl = document.createElement('model-viewer');
                    mediaEl.src = media.src;
                    mediaEl.className = "inline-block h-full w-[300px] mr-4";
                    mediaEl.setAttribute('ar', '');
                    mediaEl.setAttribute('camera-controls', '');
                    mediaEl.setAttribute('shadow-intensity', '1');
                } else if (media.type === 'html') {
                    mediaEl = document.createElement('iframe');
                    let url = media.src;
                    if (url.includes('raw.githubusercontent.com') && url.endsWith('.html')) {
                        url = url.replace('raw.githubusercontent.com', 'raw.githack.com').replace('/refs/heads/', '/'); 
                    }
                    const wrapper = document.createElement('div');
                    wrapper.className = "inline-block h-full aspect-video min-w-[300px] md:min-w-[400px] mr-4 bg-white overflow-hidden relative border border-gray-200 shadow-sm";
                    mediaEl.src = url;
                    mediaEl.className = "absolute top-0 left-0 w-[200%] h-[200%] border-none origin-top-left scale-50";
                    mediaEl.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
                    mediaEl.allowFullscreen = true;
                    wrapper.appendChild(mediaEl);
                    modalMediaScroller.appendChild(wrapper);
                    return; 
                }
                
                if (mediaEl) modalMediaScroller.appendChild(mediaEl);
            });

            const allMetadata = { 'Project': project.name, ...project.categories };
            if (project.link) allMetadata['Link'] = `<a href="${project.link}" target="_blank" class="underline ui-text">${project.link}</a>`;

            let leftHtml = '<div class="space-y-4 ui-text text-sm">';
            // Project Name Block
            leftHtml += `<div class="mb-2">
                             <div class="modal-label opacity-70 uppercase tracking-widest mb-1">Project:</div>
                             <div class="modal-value font-bold text-lg leading-tight">${allMetadata['Project']}</div>
                          </div>`;
            
            // Flex Container for Categories (Auto wrap)
            leftHtml += '<div class="flex flex-wrap gap-x-4 gap-y-2">';
            
            // Generate details based on categoryPriorityList order
            categoryPriorityList.forEach(key => {
                if (allMetadata[key]) {
                    // Display as compact inline blocks: "Label: Value"
                    leftHtml += `<div class="inline-flex items-baseline">
                        <span class="modal-label opacity-70 uppercase tracking-widest mr-1">${key}:</span> 
                        <span class="modal-value capitalize">${allMetadata[key]}</span>
                    </div>`;
                }
            });
            
            if (allMetadata['Link']) {
                 leftHtml += `<div class="inline-flex items-baseline"><span class="modal-label opacity-70 uppercase mr-1">Link:</span> <span>${allMetadata['Link']}</span></div>`;
            }
            
            leftHtml += '</div></div>'; // Close flex container and main wrapper
            
            modalLeftCol.innerHTML = leftHtml;
            modalRightCol.innerHTML = `<p class="modal-desc leading-relaxed">${project.description || ''}</p>`;
            
            modalContainer.classList.add('open');
            modalBackdrop.classList.add('open');
        }

        function closeModal() {
            modalContainer.classList.remove('open');
            modalBackdrop.classList.remove('open');
            setTimeout(() => { modalMediaScroller.innerHTML = ''; }, 300);
        }

        // --- EVENTS ---
        searchInput.addEventListener('input', (e) => {
            currentSearchQuery = e.target.value;
            renderAccordion();
        });
        modalCloseBtn.addEventListener('click', closeModal);
        modalBackdrop.addEventListener('click', closeModal);
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
        
        // --- MOUSE MOVE FOR THUMBNAIL (DESKTOP) ---
        document.addEventListener('mousemove', (e) => {
            if (thumbnailPreview.classList.contains('visible') && window.innerWidth >= 768) {
                // Bounds check
                let leftPos = e.clientX + 20;
                if (leftPos + 250 > window.innerWidth) {
                    leftPos = e.clientX - 270;
                }
                
                thumbnailPreview.style.left = leftPos + 'px';
                thumbnailPreview.style.top = (e.clientY + 20) + 'px';
            }
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            renderFilterButtons();
            renderAccordion();
        });

    </script>
</body>
</html>
